# syntax=docker/dockerfile:1.6

# Use a stable Python base to avoid apt hash mismatch issues
FROM python:3.11-slim-bookworm

ARG TARGETPLATFORM
ARG TARGETOS
ARG TARGETARCH
ARG TARGETVARIANT

USER root

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# System packages required for TURN, debugging, and health checks
RUN set -eux; \
    rm -rf /var/lib/apt/lists/*; \
    if [ -f /etc/apt/sources.list ]; then \
      sed -i 's|deb http://deb.debian.org/debian bookworm main|deb http://deb.debian.org/debian bookworm main contrib non-free|g' /etc/apt/sources.list || true; \
    else \
      printf 'deb http://deb.debian.org/debian bookworm main contrib non-free\n' > /etc/apt/sources.list; \
    fi; \
    printf 'deb http://deb.debian.org/debian bookworm-updates main contrib non-free\n' > /etc/apt/sources.list.d/bookworm-updates.list; \
    printf 'deb http://deb.debian.org/debian bookworm-backports main contrib non-free\n' > /etc/apt/sources.list.d/bookworm-backports.list; \
    for i in 1 2 3; do \
      apt-get update -o Acquire::http::No-Cache=true -o Acquire::https::No-Cache=true -o Acquire::CompressionTypes::Order::=gz \
      && apt-get install -y --no-install-recommends \
           curl procps \
           libavdevice59 libavformat59 libavfilter8 libavcodec59 libavutil57 libswscale6 \
           libopus0 libvpx7 libsrtp2-1 \
      && break \
      || (echo "APT attempt $i failed; cleaning and retrying"; apt-get clean; rm -rf /var/lib/apt/lists/* /var/lib/apt/lists/partial; sleep 4); \
    done; \
    for i in 1 2 3; do \
      apt-get install -y -t bookworm-backports --no-install-recommends coturn \
      && break \
      || (echo "APT coturn attempt $i failed; cleaning and retrying"; apt-get clean; rm -rf /var/lib/apt/lists/* /var/lib/apt/lists/partial; sleep 4; apt-get update); \
    done; \
    rm -rf /var/lib/apt/lists/*

# Python deps
ARG INSTALL_HEAVY_DEPS=false
COPY tensordock/requirements.txt /tmp/requirements.txt
RUN set -eux; \
    python -m pip install --no-cache-dir -r /tmp/requirements.txt; \
    if [ "$INSTALL_HEAVY_DEPS" = "true" ]; then \
        python -m pip install --no-cache-dir numpy pandas matplotlib scikit-learn tensorflow torch torchvision || true; \
    fi

# Create non-root user
ENV NB_USER=jovyan \
    NB_UID=1000
RUN useradd -m -u ${NB_UID} -s /bin/bash ${NB_USER} || true

# App
WORKDIR /app
COPY tensordock/ /app/
RUN rm -rf /app/control-plane && mkdir -p /app/logs && chown -R ${NB_USER}:${NB_USER} /app && chmod +x /app/start.sh

USER ${NB_USER}
EXPOSE 8888
EXPOSE 3478/udp
EXPOSE 49152-65535/udp

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8888/ || exit 1

CMD ["/app/start.sh"]