[supervisord]
user=root
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
# Environment variables are inherited from Docker container
# Use %(ENV_VAR_NAME)s in program sections to access them
# VastAI port variables (VAST_TCP_PORT_70000, etc.) are set by VastAI and must be
# explicitly exported in the onstart script before supervisord starts

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0770
chown=root:watcher
# Note: chown only works when socket is first created
# If socket exists from previous run, it may need manual permission fix
# The monitor service will attempt to fix permissions but requires root

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:jupyter]
command=/usr/local/bin/jupyter server --port=8888 --IdentityProvider.token=%(ENV_JUPYTER_TOKEN)s
directory=/app
user=appuser
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/jupyter.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
# Environment variables are inherited from supervisord (which inherits from Docker)
# Only set static variables here; dynamic ones come from Docker -e flags
environment=USER="appuser",HOME="/home/appuser",XDG_DATA_HOME="/tmp/.local/share",XDG_CONFIG_HOME="/tmp/.config",XDG_CACHE_HOME="/tmp/.cache",JUPYTER_RUNTIME_DIR="/tmp/jupyter-runtime",JUPYTER_DATA_DIR="/tmp/jupyter-data",JUPYTER_CONFIG_DIR="/tmp/jupyter-config",TD_LOG_DIR="/tmp/tensordock-logs"

[program:python_server]
command=/usr/local/bin/python -u /app/run_modular.py
directory=/app
user=appuser
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/python_server.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=USER="appuser",HOME="/home/appuser",XDG_DATA_HOME="/tmp/.local/share",XDG_CONFIG_HOME="/tmp/.config",XDG_CACHE_HOME="/tmp/.cache",TD_LOG_DIR="/tmp/tensordock-logs"

[program:turn_server]
command=/bin/bash -c "if [ \"%(ENV_START_TURN)s\" = \"true\" ]; then EXTERNAL_IP=\"\"; if [ -n \"%(ENV_PUBLIC_IPADDR)s\" ] && [ \"%(ENV_PUBLIC_IPADDR)s\" != \"auto\" ]; then EXTERNAL_IP=\"--external-ip=%(ENV_PUBLIC_IPADDR)s\"; elif [ \"%(ENV_PUBLIC_IPADDR)s\" = \"auto\" ]; then META_IP=$(curl -fsS --max-time 2 http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address 2>/dev/null || true); if [ -n \"$META_IP\" ]; then EXTERNAL_IP=\"--external-ip=$META_IP\"; else EXTERNAL_IP=\"--external-ip=$(curl -fsS --max-time 3 https://ifconfig.co 2>/dev/null || true)\"; fi; fi; /usr/bin/turnserver -n -a --log-file=stdout --lt-cred-mech --fingerprint --no-multicast-peers --no-cli --no-tlsv1 --no-tlsv1_1 --realm=example.org --user=%(ENV_TURN_USERNAME)s:%(ENV_TURN_PASSWORD)s --listening-port=3478 --listening-ip=0.0.0.0 --min-port=49152 --max-port=65535 --userdb=/tmp/turnserver.sqlite $EXTERNAL_IP; else exit 0; fi"
directory=/app
user=appuser
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/turn_server.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
# Environment variables are inherited from supervisord (which inherits from Docker)
# Only set static variables here; dynamic ones come from Docker -e flags
environment=USER="appuser",HOME="/home/appuser"

[program:monitor]
command=/usr/local/bin/python -u /app/monitor_service.py
directory=/app
user=watcher
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/monitor.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
# Environment variables are inherited from supervisord (which inherits from Docker)
# VastAI port variables (VAST_TCP_PORT_70000, etc.) are passed via %(ENV_VAR_NAME)s
# These are set by VastAI and exported in the onstart script before supervisord starts
environment=USER="watcher",HOME="/home/watcher",VAST_TCP_PORT_70000="%(ENV_VAST_TCP_PORT_70000)s",VAST_UDP_PORT_70001="%(ENV_VAST_UDP_PORT_70001)s",VAST_TCP_PORT_70002="%(ENV_VAST_TCP_PORT_70002)s",VAST_TCP_PORT_22="%(ENV_VAST_TCP_PORT_22)s"

